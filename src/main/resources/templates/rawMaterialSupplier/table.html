<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataTable - Mazer Admin Dashboard</title>

    <link rel="shortcut icon" href="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/1999/svg'%20viewBox='0%200%2033%2034'%20fill-rule='evenodd'%20stroke-linejoin='round'%20stroke-miterlimit='2'%20xmlns:v='https://vecta.io/nano'%3e%3cpath%20d='M3%2027.472c0%204.409%206.18%205.552%2013.5%205.552%207.281%200%2013.5-1.103%2013.5-5.513s-6.179-5.552-13.5-5.552c-7.281%200-13.5%201.103-13.5%205.513z'%20fill='%23435ebe'%20fill-rule='nonzero'/%3e%3ccircle%20cx='16.5'%20cy='8.8'%20r='8.8'%20fill='%2341bbdd'/%3e%3c/svg%3e" type="image/x-icon">
    <link rel="stylesheet" href="/assets/extensions/simple-datatables/style.css">
    <link rel="stylesheet" href="/assets/compiled/css/table-datatable.css">
    <link rel="stylesheet" href="/assets/compiled/css/app.css">
    <link rel="stylesheet" href="/assets/compiled/css/app-dark.css">
</head>

<body>

<div id="app">
    <div id="sidebar" th:replace="~{layout/layout :: sidebar}"></div>
    <div id="main" class="layout-navbar navbar-fixed">
        <header class="mb-3" th:replace="~{layout/layout :: header}">
            <a href="#" class="burger-btn d-block d-xl-none">
                <i class="bi bi-justify fs-3"></i>
            </a>
        </header>

        <div class="page-heading">
            <div class="page-title">
                <div class="row">
                    <div class="col-12 col-md-6 order-md-1 order-last">
                        <h3>Supplier</h3>
                        <p class="text-subtitle text-muted">A sortable, searchable, paginated table without dependencies thanks to simple-datatables.</p>
                    </div>
                    <div class="col-12 col-md-6 order-md-2 order-first">
                        <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="index.html">Dashboard</a></li>
                                <li class="breadcrumb-item active" aria-current="page">DataTable</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>

            <section class="section">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Simple Datatable</h4>
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#registerModal">Add New Supplier</button>

                        <form id="supplierUploadForm" enctype="multipart/form-data" class="mb-3">
                            <input type="file" name="file" accept=".csv" required class="form-control w-auto d-inline-block" />
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-upload"></i> 공급처 CSV 업로드
                            </button>
                        </form>

                        <div class="text-end mb-3">
                            <a href="/download/excel/supplier" class="btn btn-success">
                                <i class="bi bi-download"></i> Supplier Excel
                            </a>
                            <a href="/download/csv/supplier" class="btn btn-secondary">
                                <i class="bi bi-file-earmark-text"></i> Supplier CSV
                            </a>
                        </div>

                    </div>
                    <div class="card-body">
                        <table class="table table-striped" id="table1">
                            <thead>
                            <tr>
                                <th th:each="col : ${columns}" th:text="${col}"></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="supplier : ${suppliers}">
                                <td th:text="${supplier.supplierId}"></td>
                                <td th:text="${supplier.supplierName}"></td>
                                <td th:text="${supplier.contactInfo}"></td>
                                <td th:text="${supplier.address}"></td>
                                <td th:text="${supplier.email}"></td>
                                <td th:text="${supplier.phoneNumber}"></td>
                                <td th:text="${supplier.regDate}"></td>
                                <td th:text="${supplier.modDate}"></td>
                                <td>
                                    <button class="btn btn-outline-primary btn-edit" data-bs-toggle="modal" data-bs-target="#editModal"
                                            th:data-id="${supplier.supplierId}"
                                            th:data-name="${supplier.supplierName}"
                                            th:data-contact="${supplier.contactInfo}"
                                            th:data-address="${supplier.address}"
                                            th:data-email="${supplier.email}"
                                            th:data-phoneNumber="${supplier.phoneNumber}"
                                            th:data-reg="${supplier.regDate}"
                                            th:data-mod="${supplier.modDate}">Edit</button>
                                    <button class="btn btn-outline-info btn-delete" data-bs-toggle="modal" data-bs-target="#deleteModal" th:data-id="${supplier.supplierId}">Delete</button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 고객 등록 모달 -->
            <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="registerModalLabel">Register New Supplier</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form action="/table/rawMaterialSupplier/register" method="POST">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="supplierName" class="form-label">Supplier Name</label>
                                    <input type="text" class="form-control" id="supplierName" name="supplierName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="contactInfo" class="form-label">Contact Information</label>
                                    <input type="text" class="form-control" id="contactInfo" name="contactInfo" required>
                                </div>
                                <div class="mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="address" name="address" required>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="text" class="form-control" id="email" name="email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="phoneNumber" class="form-label">PhoneNumber</label>
                                    <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" required>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Register</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 고객 수정 모달 -->
            <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editModalLabel">Edit Supplier</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form action="/table/rawMaterialSupplier/edit/{supplierId}" method="POST" id="editSupplierForm">
                            <div class="modal-body">
                                <input type="hidden" id="editSupplierId" name="supplierId">
                                <div class="mb-3">
                                    <label for="editSupplierName" class="form-label">Supplier Name</label>
                                    <input type="text" class="form-control" id="editSupplierName" name="supplierName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editContactInfo" class="form-label">Contact Information</label>
                                    <input type="text" class="form-control" id="editContactInfo" name="contactInfo" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editAddress" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="editAddress" name="address" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editEmail" class="form-label">Email</label>
                                    <input type="text" class="form-control" id="editEmail" name="email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editPhoneNumber" class="form-label">PhoneNumber</label>
                                    <input type="text" class="form-control" id="editPhoneNumber" name="phoneNumber" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editRegDate" class="form-label">Registration Date</label>
                                    <input type="text" class="form-control" id="editRegDate" name="regDate" readonly disabled>
                                </div>
                                <div class="mb-3">
                                    <label for="editModDate" class="form-label">Modification Date</label>
                                    <input type="text" class="form-control" id="editModDate" name="modDate" readonly disabled>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Update</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 고객 삭제 모달 -->
            <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteModalLabel">Delete Supplier</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this supplier?</p>
                        </div>
                        <div class="modal-footer">
                            <form action="#" method="GET" id="deleteSupplierForm">
                                <input type="hidden" id="deleteSupplierId" name="supplierId">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-danger">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <footer>
                <div th:replace="~{layout/layout :: footer}"></div>
            </footer>
        </div>
    </div>


    <script src="/assets/static/js/initTheme.js"></script>
    <script src="/assets/static/js/components/dark.js"></script>
    <script src="/assets/extensions/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script src="/assets/compiled/js/app.js"></script>
    <script src="/assets/extensions/simple-datatables/umd/simple-datatables.js"></script>
    <script src="/assets/static/js/pages/simple-datatables.js"></script>


    <script>
        document.addEventListener("DOMContentLoaded", function() {

        const tableBody = document.querySelector("#table1");
        const myDataTable = new simpleDatatables.DataTable(tableBody, {
            perPage: 10,
            searchable: true,
            sortable: true,
            labels: {
                placeholder: "고객을 검색하세요...",
                perPage: "{select} 행을 한 페이지에 표시",
                noRows: "고객을 찾을 수 없습니다.",
                info: "전체 {rows}개의 고객 중 {start}에서 {end}까지 표시",
            },
        });

        // 수정 버튼 클릭 (이벤트 위임)
        document.querySelector("#table1").addEventListener("click", (e) => {
            const btn = e.target.closest(".btn-edit");
            if (btn) {
                const supplierId = btn.getAttribute("data-id");
                const supplierName = btn.getAttribute("data-name");
                const contactInfo = btn.getAttribute("data-contact");
                const address = btn.getAttribute("data-address");
                const email = btn.getAttribute("data-email");
                const phoneNumber = btn.getAttribute("data-phoneNumber");
                const regDate = btn.getAttribute("data-reg");
                const modDate = btn.getAttribute("data-mod");

                document.getElementById("editSupplierId").value = supplierId;
                document.getElementById("editSupplierName").value = supplierName;
                document.getElementById("editContactInfo").value = contactInfo;
                document.getElementById("editAddress").value = address;
                document.getElementById("editEmail").value = email;
                document.getElementById("editPhoneNumber").value = phoneNumber;
                document.getElementById("editRegDate").value = regDate;
                document.getElementById("editModDate").value = modDate;
            }
        });

        const editSupplierForm = document.getElementById("editSupplierForm");
        editSupplierForm.addEventListener("submit", (event) => {
            event.preventDefault();
            const formData = new FormData(editSupplierForm);
            const supplierId = document.getElementById("editSupplierId").value;
            fetch(`/table/rawMaterialSupplier/edit/${supplierId}`, {
                method: "POST",
                body: formData,
            })
            .then((response) => {
                if (response.ok) {
                    alert("고객 정보가 수정되었습니다.");
                    location.reload();
                } else {
                    alert("고객 수정에 실패했습니다.");
                }
            })
            .catch((error) => {
                alert("에러 발생: 고객 수정 실패");
                console.error("에러:", error);
            });
        });

        // 삭제 버튼 클릭 → supplierId 세팅
        document.querySelector("#table1").addEventListener("click", (e) => {
            const btn = e.target.closest(".btn-delete");
            if (btn) {
                const supplierId = btn.getAttribute("data-id");
                console.log("선택된 고객 ID:", supplierId); // 디버깅용
                document.getElementById("deleteSupplierId").value = supplierId;
            }
        });

        // 삭제 폼 제출 → GET 요청으로 리다이렉트
        const deleteSupplierForm = document.getElementById("deleteSupplierForm");
        deleteSupplierForm.addEventListener("submit", (event) => {
            event.preventDefault();
            const supplierId = document.getElementById("deleteSupplierId").value;

            if (!supplierId) {
                alert("고객 ID가 없습니다.");
                return;
            }

            location.href = `/table/rawMaterialSupplier/delete/${supplierId}`;
            });
        });

        document.getElementById('supplierUploadForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch('/upload/csv/supplier', {
              method: 'POST',
              body: formData,
            })
            .then(res => {
              if (!res.ok) throw new Error('업로드 실패');
              return res.text();
            })
            .then(() => {
              alert('공급처 CSV 업로드 완료');
              window.location.href = '/table/rawMaterialSupplier';
            })
            .catch(err => alert('업로드 중 오류 발생: ' + err.message));
      });
    </script>

</body>
</html>
