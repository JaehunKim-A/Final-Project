<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw-Material-Inbound</title>
    <link rel="shortcut icon" href="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/1999/svg'%20viewBox='0%200%2033%2034'%20fill-rule='evenodd'%20stroke-linejoin='round'%20stroke-miterlimit='2'%20xmlns:v='https://vecta.io/nano'%3e%3cpath%20d='M3%2027.472c0%204.409%206.18%205.552%2013.5%205.552%207.281%200%2013.5-1.103%2013.5-5.513s-6.179-5.552-13.5-5.552c-7.281%200-13.5%201.103-13.5%205.513z'%20fill='%23435ebe'%20fill-rule='nonzero'/%3e%3ccircle%20cx='16.5'%20cy='8.8'%20r='8.8'%20fill='%2341bbdd'/%3e%3c/svg%3e" type="image/x-icon">
    <link rel="stylesheet" href="/assets/extensions/simple-datatables/style.css">
    <link rel="stylesheet" href="/assets/compiled/css/table-datatable.css">
    <link rel="stylesheet" href="/assets/compiled/css/app.css">
    <link rel="stylesheet" href="/assets/compiled/css/app-dark.css">
</head>
<body>

<div id="app">
    <div id="sidebar" th:replace="~{layout/layout :: sidebar}"></div>
    <div id="main" class="layout-navbar navbar-fixed">
        <header class="mb-3" th:replace="~{layout/layout :: header}">
            <a href="#" class="burger-btn d-block d-xl-none">
                <i class="bi bi-justify fs-3"></i>
            </a>
        </header>

        <h1>원자재 입고 목록</h1>

        <div class="card-body">
            <table class="table table-striped" id="table1">
                <thead>
                <tr>
                    <th>입고 ID</th>
                    <th>원자재 ID</th>
                    <th>원자재 코드</th>
                    <th>수량</th>
                    <th>입고 날짜</th>
                    <th>입고 코드</th>
                    <th>공급업체 ID</th>
                    <th>상태</th>
                    <th>관리</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="inbound : ${rawMaterialInbounds}">
                    <input type="hidden" th:value="${inbound.inboundId}">
                    <td th:text="${inbound.inboundId}"></td>
                    <td th:text="${inbound.materialId}"></td>
                    <td th:text="${inbound.materialCode}"></td>
                    <td th:text="${inbound.quantity}"></td>
                    <td th:text="${inbound.inboundDate}"></td>
                    <td th:text="${inbound.inboundCode}"></td>
                    <td th:text="${inbound.supplierId}"></td>
                    <td th:text="${inbound.status}"></td>
                    <td>
                        <button class="btn btn-outline-primary edit-btn"
                                data-bs-toggle="modal" data-bs-target="#editModal"
                                th:data-id="${inbound.inboundId}"
                                th:data-material-id="${inbound.materialId}"
                                th:data-material-code="${inbound.materialCode}"
                                th:data-quantity="${inbound.quantity}"
                                th:data-inbound-date="${inbound.inboundDate}"
                                th:data-inbound-code="${inbound.inboundCode}"
                                th:data-supplier-id="${inbound.supplierId}"
                                th:data-status="${inbound.status}">
                            Edit
                        </button>
                        <button class="btn btn-outline-danger delete-btn"
                                data-bs-toggle="modal" data-bs-target="#deleteModal"
                                th:data-id="${inbound.inboundId}">
                            Delete
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- 수정 모달 -->
        <div class="modal fade" id="editRawMaterialInboundModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">원자재 입고 수정</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editRawMaterialInboundForm">
                            <input type="hidden" id="editInboundId">
                            <div class="mb-3">
                                <label class="form-label">원자재 ID</label>
                                <input type="text" class="form-control" id="editMaterialId" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">원자재 코드</label>
                                <input type="text" class="form-control" id="editMaterialCode" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">수량</label>
                                <input type="number" class="form-control" id="editQuantity" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">입고 날짜</label>
                                <input type="date" class="form-control" id="editInboundDate" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">입고 코드</label>
                                <input type="text" class="form-control" id="editInboundCode" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">공급업체 ID</label>
                                <input type="text" class="form-control" id="editSupplierId" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">상태</label>
                                <select id="editStatus" class="form-control">
                                    <option value="Complete">Complete</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Canceled">Canceled</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">수정 완료</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 삭제 결과 모달 -->
        <div class="modal fade" id="deleteModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">알림</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p id="deleteModalMessage"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">확인</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 스크립트 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/static/js/initTheme.js"></script>
<script src="/assets/static/js/components/dark.js"></script>
<script src="/assets/extensions/perfect-scrollbar/perfect-scrollbar.min.js"></script>
<script src="/assets/compiled/js/app.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // 수정 버튼 클릭 시
        document.querySelectorAll(".edit-btn").forEach(button => {
            button.addEventListener("click", function () {
                document.getElementById("editInboundId").value = this.dataset.id;
                document.getElementById("editMaterialId").value = this.dataset.materialId;
                document.getElementById("editMaterialCode").value = this.dataset.materialCode;
                document.getElementById("editQuantity").value = this.dataset.quantity;
                document.getElementById("editInboundDate").value = this.dataset.inboundDate;
                document.getElementById("editInboundCode").value = this.dataset.inboundCode;
                document.getElementById("editSupplierId").value = this.dataset.supplierId;
                document.getElementById("editStatus").value = this.dataset.status;

                const editModal = new bootstrap.Modal(document.getElementById("editRawMaterialInboundModal"));
                editModal.show();
            });
        });

        // 수정 제출
        document.getElementById("editRawMaterialInboundForm").addEventListener("submit", function (event) {
            event.preventDefault();

            const dto = {
                inboundId: document.getElementById("editInboundId").value,
                materialId: document.getElementById("editMaterialId").value,
                materialCode: document.getElementById("editMaterialCode").value,
                quantity: document.getElementById("editQuantity").value,
                inboundDate: document.getElementById("editInboundDate").value,
                inboundCode: document.getElementById("editInboundCode").value,
                supplierId: document.getElementById("editSupplierId").value,
                status: document.getElementById("editStatus").value
            };

            fetch(`/raw-material/inbound/update/${dto.inboundId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dto)
            })
            .then(response => {
                if (!response.ok) throw new Error("수정 실패");
                return response.text();
            })
            .then(() => {
                alert("수정 완료");
                bootstrap.Modal.getInstance(document.getElementById("editRawMaterialInboundModal")).hide();
                window.location.reload();
            })
            .catch(() => {
                alert("수정 중 오류 발생");
            });
        });

        // 삭제
        document.querySelectorAll(".delete-btn").forEach(button => {
            button.addEventListener("click", function () {
                const inboundId = this.dataset.id;
                if (confirm(`${inboundId}번 데이터를 삭제하시겠습니까?`)) {
                    fetch(`/raw-material/inbound/delete/${inboundId}`, {
                        method: 'DELETE'
                    })
                    .then(res => {
                        if (!res.ok) throw new Error();
                        this.closest("tr").remove();
                        showModal("삭제가 완료되었습니다.");
                    })
                    .catch(() => showModal("삭제 중 오류 발생"));
                }
            });
        });

        function showModal(message) {
            document.getElementById("deleteModalMessage").textContent = message;
            new bootstrap.Modal(document.getElementById("deleteModal")).show();
        }
    });
</script>
</body>
</html>
