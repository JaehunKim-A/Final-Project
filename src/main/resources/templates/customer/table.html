<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataTable - Mazer Admin Dashboard</title>

    <link rel="shortcut icon" href="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/1999/svg'%20viewBox='0%200%2033%2034'%20fill-rule='evenodd'%20stroke-linejoin='round'%20stroke-miterlimit='2'%20xmlns:v='https://vecta.io/nano'%3e%3cpath%20d='M3%2027.472c0%204.409%206.18%205.552%2013.5%205.552%207.281%200%2013.5-1.103%2013.5-5.513s-6.179-5.552-13.5-5.552c-7.281%200-13.5%201.103-13.5%205.513z'%20fill='%23435ebe'%20fill-rule='nonzero'/%3e%3ccircle%20cx='16.5'%20cy='8.8'%20r='8.8'%20fill='%2341bbdd'/%3e%3c/svg%3e" type="image/x-icon">

    <link rel="stylesheet" href="/assets/extensions/simple-datatables/style.css">
    <link rel="stylesheet" href="/assets/compiled/css/table-datatable.css">
    <link rel="stylesheet" href="/assets/compiled/css/app.css">
    <link rel="stylesheet" href="/assets/compiled/css/app-dark.css">

</head>

<body>

<div id="app">
    <div id="sidebar" th:replace="~{layout/layout :: sidebar}"></div>
    <div id="main" class="layout-navbar navbar-fixed">
        <header class="mb-3" th:replace="~{layout/layout :: header}">
            <a href="#" class="burger-btn d-block d-xl-none">
                <i class="bi bi-justify fs-3"></i>
            </a>
        </header>

        <div class="page-heading">
            <div class="page-title">
                <div class="row">
                    <div class="col-12 col-md-6 order-md-1 order-last">
                        <h3>Customer</h3>
                        <p class="text-subtitle text-muted">A sortable, searchable, paginated table without dependencies thanks to simple-datatables.</p>
                    </div>
                    <div class="col-12 col-md-6 order-md-2 order-first">
                        <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="index.html">Dashboard</a></li>
                                <li class="breadcrumb-item active" aria-current="page">DataTable</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>

            <section class="section">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Simple Datatable</h4>
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                            <!-- Left Side: Add + Upload -->
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#registerModal">
                                    Add New Customer
                                </button>

                                <form id="csvUploadForm" method="post" action="/upload/csv/customer" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
                                    <input type="file" name="file" accept=".csv" required class="form-control w-auto">
                                    <button type="submit" class="btn btn-outline-primary">
                                        <i class="bi bi-upload"></i> 고객 CSV 업로드
                                    </button>
                                </form>
                                <a href="/download/sample/customer" class="btn btn-outline-secondary">
                                    <i class="bi bi-download"></i> 고객 CSV 샘플 다운로드
                                </a>

                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <a href="/download/excel/customer" class="btn btn-outline-success">
                                    <i class="bi bi-download"></i> Customer Excel
                                </a>
                                <a href="/download/csv/customer" class="btn btn-outline-secondary">
                                    <i class="bi bi-file-earmark-text"></i> Customer CSV
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped" id="table1">
                            <thead>
                            <tr>
                                <th>이름</th>
                                <th>연락처</th>
                                <th>주소</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="customer : ${customers}">
                                <td th:text="${customer.customerName}" class="customer-detail-toggle" style="cursor: pointer;"></td>
                                <td th:text="${customer.contactInfo}" class="customer-detail-toggle" style="cursor: pointer;"></td>
                                <td th:text="${customer.address}" class="customer-detail-toggle" style="cursor: pointer;"></td>

                                <td class="d-none customer-id" th:text="${customer.customerId}"></td>
                                <td class="d-none customer-reg" th:text="${customer.regDate}"></td>
                                <td class="d-none customer-mod" th:text="${customer.modDate}"></td>
                            </tr>
                            </tbody>
                        </table>


                    </div>
                </div>
            </section>

            <!-- 고객 등록 모달 -->
            <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="registerModalLabel">Register New Customer</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form action="/table/customer/register" method="POST">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="customerName" class="form-label">Customer Name</label>
                                    <input type="text" class="form-control" id="customerName" name="customerName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="contactInfo" class="form-label">Contact Information</label>
                                    <input type="text" class="form-control" id="contactInfo" name="contactInfo" required>
                                </div>
                                <div class="mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="address" name="address" required>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Register</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 고객 수정 모달 -->
            <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editModalLabel">Edit Customer</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form action="/table/customer/edit/{customerId}" method="POST" id="editCustomerForm">
                            <div class="modal-body">
                                <input type="hidden" id="editCustomerId" name="customerId">
                                <div class="mb-3">
                                    <label for="editCustomerName" class="form-label">Customer Name</label>
                                    <input type="text" class="form-control" id="editCustomerName" name="customerName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editContactInfo" class="form-label">Contact Information</label>
                                    <input type="text" class="form-control" id="editContactInfo" name="contactInfo" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editAddress" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="editAddress" name="address" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editRegDate" class="form-label">Registration Date</label>
                                    <input type="text" class="form-control" id="editRegDate" name="regDate" readonly disabled>
                                </div>
                                <div class="mb-3">
                                    <label for="editModDate" class="form-label">Modification Date</label>
                                    <input type="text" class="form-control" id="editModDate" name="modDate" readonly disabled>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Update</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 고객 삭제 모달 -->
            <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteModalLabel">Delete Customer</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this customer?</p>
                        </div>
                        <div class="modal-footer">
                            <form action="#" method="GET" id="deleteCustomerForm">
                                <input type="hidden" id="deleteCustomerId" name="customerId">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-danger">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <footer>
                <div th:replace="~{layout/layout :: footer}"></div>
            </footer>
        </div>
    </div>


    <script src="/assets/static/js/initTheme.js"></script>
    <script src="/assets/static/js/components/dark.js"></script>
    <script src="/assets/extensions/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script src="/assets/compiled/js/app.js"></script>
    <script src="/assets/extensions/simple-datatables/umd/simple-datatables.js"></script>
    <script src="/assets/static/js/pages/simple-datatables.js"></script>


    <script>
        document.addEventListener("DOMContentLoaded", function() {

        const tableBody = document.querySelector("#table1");
        const myDataTable = new simpleDatatables.DataTable(tableBody, {
            perPage: 10,
            searchable: true,
            sortable: true,
            labels: {
                placeholder: "고객을 검색하세요...",
                perPage: "{select} 행을 한 페이지에 표시",
                noRows: "고객을 찾을 수 없습니다.",
                info: "전체 {rows}개의 고객 중 {start}에서 {end}까지 표시",
            },
        });

        // 수정 버튼 클릭 (이벤트 위임)
        document.querySelector("#table1").addEventListener("click", (e) => {
            const btn = e.target.closest(".btn-edit");
            if (btn) {
                const customerId = btn.getAttribute("data-id");
                const customerName = btn.getAttribute("data-name");
                const contactInfo = btn.getAttribute("data-contact");
                const address = btn.getAttribute("data-address");
                const regDate = btn.getAttribute("data-reg");
                const modDate = btn.getAttribute("data-mod");

                document.getElementById("editCustomerId").value = customerId;
                document.getElementById("editCustomerName").value = customerName;
                document.getElementById("editContactInfo").value = contactInfo;
                document.getElementById("editAddress").value = address;
                document.getElementById("editRegDate").value = regDate;
                document.getElementById("editModDate").value = modDate;
            }
        });

        const editCustomerForm = document.getElementById("editCustomerForm");
        editCustomerForm.addEventListener("submit", (event) => {
            event.preventDefault();
            const formData = new FormData(editCustomerForm);
            const customerId = document.getElementById("editCustomerId").value;
            fetch(`/table/customer/edit/${customerId}`, {
                method: "POST",
                body: formData,
            })
            .then((response) => {
                if (response.ok) {
                    alert("고객 정보가 수정되었습니다.");
                    location.reload();
                } else {
                    alert("고객 수정에 실패했습니다.");
                }
            })
            .catch((error) => {
                alert("에러 발생: 고객 수정 실패");
                console.error("에러:", error);
            });
        });

        // 삭제 버튼 클릭 → customerId 세팅
        document.querySelector("#table1").addEventListener("click", (e) => {
            const btn = e.target.closest(".btn-delete");
            if (btn) {
                const customerId = btn.getAttribute("data-id");
                console.log("선택된 고객 ID:", customerId); // 디버깅용
                document.getElementById("deleteCustomerId").value = customerId;
            }
        });

        // 삭제 폼 제출 → GET 요청으로 리다이렉트
        const deleteCustomerForm = document.getElementById("deleteCustomerForm");
        deleteCustomerForm.addEventListener("submit", (event) => {
            event.preventDefault();
            const customerId = document.getElementById("deleteCustomerId").value;

            if (!customerId) {
                alert("고객 ID가 없습니다.");
                return;
            }

            location.href = `/table/customer/delete/${customerId}`;
            });
        });

    document.querySelector("#table1").addEventListener("click", function (e) {
    const detailCell = e.target.closest(".customer-detail-toggle");
    if (!detailCell) return;

    const row = detailCell.closest("tr");
    const nextRow = row.nextElementSibling;

    // 이미 열려 있는 경우 → 닫고 return
    if (nextRow && nextRow.classList.contains("accordion-row")) {
        const collapseEl = nextRow.querySelector(".accordion-collapse");
        if (collapseEl) {
            const collapseInstance = bootstrap.Collapse.getOrCreateInstance(collapseEl);
            collapseInstance.hide();
        }
        nextRow.remove(); // DOM에서 제거
        return;
    }

    // 새로 열기
    const customerId = row.querySelector(".customer-id")?.innerText || "";
    const customerName = row.querySelectorAll("td")[0]?.innerText || "";
    const contactInfo = row.querySelectorAll("td")[1]?.innerText || "";
    const address = row.querySelectorAll("td")[2]?.innerText || "";
    const regDate = row.querySelector(".customer-reg")?.innerText || "";
    const modDate = row.querySelector(".customer-mod")?.innerText || "";

    const accordionId = `accordionDetail-${row.rowIndex}`;
    const collapseId = `collapse-${row.rowIndex}`;

    const accordionHTML = `
        <div class="accordion" id="${accordionId}">
            <div class="accordion-item">
                <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="heading-${row.rowIndex}">
                    <div class="accordion-body p-0">
                        <table class="table table-bordered mb-0 align-middle">
                            <thead>
                                <tr>
                                    <th>고객ID</th>
                                    <th>이름</th>
                                    <th>연락처</th>
                                    <th>주소</th>
                                    <th>등록일</th>
                                    <th>수정일</th>
                                    <th>수정/삭제</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${customerId}</td>
                                    <td>${customerName}</td>
                                    <td>${contactInfo}</td>
                                    <td>${address}</td>
                                    <td>${regDate}</td>
                                    <td>${modDate}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary btn-edit"
                                            data-bs-toggle="modal" data-bs-target="#editModal"
                                            data-id="${customerId}"
                                            data-name="${customerName}"
                                            data-contact="${contactInfo}"
                                            data-address="${address}"
                                            data-reg="${regDate}"
                                            data-mod="${modDate}">Edit</button>
                                        <button class="btn btn-sm btn-outline-info btn-delete"
                                            data-bs-toggle="modal" data-bs-target="#deleteModal"
                                            data-id="${customerId}">Delete</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>`;

    const accordionRow = document.createElement("tr");
    accordionRow.classList.add("accordion-row");
    accordionRow.innerHTML = `<td colspan="7">${accordionHTML}</td>`;
    row.parentNode.insertBefore(accordionRow, row.nextSibling);

    // Bootstrap 애니메이션으로 show
    const collapseEl = document.getElementById(collapseId);
    if (collapseEl) {
        const collapseInstance = new bootstrap.Collapse(collapseEl, {
            toggle: true
        });
    }
});

    const csvUploadForm = document.getElementById("csvUploadForm");

    csvUploadForm.addEventListener("submit", function (e) {
    e.preventDefault();

    const formData = new FormData(csvUploadForm);

    fetch("/upload/csv/customer", {
        method: "POST",
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error("업로드 실패");
        return response.text();
    })
    .then(() => {
        alert("고객 CSV 업로드가 완료되었습니다.");
        window.location.href = "/table/customer";
    })
    .catch(error => {
        alert("CSV 업로드 중 오류가 발생했습니다.");
        console.error("에러:", error);
    });
});

    </script>

</body>
</html>
